# ğŸš€ Quick Start Guide - CIG vá»›i Pseudo-Target Generation

## âš¡ TL;DR - Cháº¡y Ngay

```powershell
# 1. Activate virtual environment
.\venv\Scripts\Activate.ps1

# 2. Test workflow
python test_pseudo_target_workflow.py

# 3. Start API server
python api_pseudo_target.py

# 4. Má»Ÿ website trong browser
start demo_website_pseudo_target.html
```

---

## ğŸ“‹ Checklist TrÆ°á»›c Khi Báº¯t Äáº§u

### âœ… Environment Setup

- [x] Python 3.10 virtual environment Ä‘Ã£ táº¡o
- [x] Dependencies Ä‘Ã£ cÃ i (requirements.txt)

### âœ… Models

- [x] `models/phi_best.pt` (~50MB)
- [x] `models/phi_best_giga.pt` (~50MB)
- [x] `models/checkpoint-20000-SDXL/checkpoint-20000/unet/` (~5GB)

### â“ Database

- [ ] Database images Ä‘Ã£ download?
- [ ] Database embeddings Ä‘Ã£ extract?

---

## ğŸ¯ Setup Flow (Chá»‰ Cháº¡y 1 Láº§n)

### BÆ°á»›c 1: Download Database Images

**Náº¿u chÆ°a cÃ³ áº£nh:**

```powershell
python download_images.py --dataset fashioniq --categories dress shirt toptee
```

**Time:** ~1-2 giá» (tÃ¹y tá»‘c Ä‘á»™ máº¡ng)  
**Size:** ~50GB  
**Output:** `datasets/FashionIQ/images/downloaded/{category}/`

**Náº¿u Ä‘Ã£ cÃ³ áº£nh:** Skip bÆ°á»›c nÃ y

---

### BÆ°á»›c 2: Extract Database Embeddings

```powershell
python extract_database_features.py `
  --dataset fashioniq `
  --categories dress shirt toptee `
  --device cuda
```

**Time:**

- GPU (RTX 3080): ~15 phÃºt
- GPU (RTX 3060): ~30 phÃºt
- CPU: ~2 giá»

**Output:** `database_embeddings/fashioniq_database.pt` (~500MB)

**Kiá»ƒm tra:**

```powershell
ls database_embeddings\fashioniq_database.pt
```

---

### BÆ°á»›c 3: (Optional) XÃ³a Images

```powershell
# Sau khi extract xong, cÃ³ thá»ƒ xÃ³a Ä‘á»ƒ tiáº¿t kiá»‡m space
# Remove-Item -Recurse -Force datasets\FashionIQ\images\downloaded\
```

âš ï¸ **LÆ°u Ã½:** Chá»‰ xÃ³a náº¿u cháº¯c cháº¯n khÃ´ng cáº§n extract láº¡i!

---

## ğŸ§ª Testing

### Test 1: Quick Workflow Test

```powershell
python test_pseudo_target_workflow.py
```

**Expected output:**

```
========================================
TEST 1: Checking Model Files
========================================
âœ… Phi ViT: ./models/phi_best.pt
âœ… Phi Giga: ./models/phi_best_giga.pt
âœ… SDXL UNet: ./models/checkpoint-20000-SDXL/checkpoint-20000/unet

âœ… All models found!

========================================
TEST 2: Loading Models into Memory
========================================
Device: cuda
ğŸ“¥ Loading CLIP Vision...
   âœ… CLIP Vision loaded
ğŸ“¥ Loading Phi...
   âœ… Phi loaded
ğŸ“¥ Loading SDXL...
   âœ… SDXL loaded

âœ… All models loaded successfully!

...
```

**Náº¿u cÃ³ lá»—i:** Check Troubleshooting section

---

### Test 2: Start API Server

```powershell
python api_pseudo_target.py
```

**Expected output:**

```
ğŸš€ Starting server and loading models...
Device: cuda
ğŸ“¥ Loading CLIP models...
âœ… CLIP models loaded
ğŸ“¥ Loading Phi model...
âœ… Phi model loaded
ğŸ“¥ Loading SDXL pipeline (this may take a while)...
âœ… SDXL pipeline loaded
ğŸ“¥ Loading database embeddings...
âœ… Loaded 77683 database embeddings
âœ… All models loaded successfully!

======================================================================
ğŸŒ Starting Flask API server...
======================================================================
Approach: Pseudo-Target Generation (CIG Model)
...
Server will run on: http://localhost:5000
======================================================================

 * Running on http://0.0.0.0:5000
```

**Keep this terminal open!**

---

### Test 3: Check API Health

**Má»Ÿ terminal má»›i:**

```powershell
curl http://localhost:5000/health
```

**Expected response:**

```json
{
  "status": "healthy",
  "device": "cuda",
  "database_size": 77683,
  "sdxl_loaded": true,
  "approach": "Pseudo-Target Generation"
}
```

---

### Test 4: Open Website

```powershell
start demo_website_pseudo_target.html
```

**Hoáº·c:** KÃ©o file vÃ o browser

---

## ğŸ® Sá»­ Dá»¥ng Website

### 1. Upload Reference Image

- Click "Upload Reference Image"
- Chá»n áº£nh quáº§n Ã¡o (shirt, dress, toptee)
- âœ… Preview hiá»ƒn thá»‹

### 2. Enter Text Query

- Example: "change to red color"
- Example: "make it darker and longer sleeves"
- Hoáº·c click example tags

### 3. Click "Generate & Search"

- â³ Loading (~10-30s)
- ğŸ¨ SDXL generating pseudo-target

### 4. View Results

- ğŸ¯ **Pseudo-Target Image** (generated by SDXL)
- â±ï¸ Timing info (generation + search)
- ğŸ“Š Top 20 retrieval results
- ğŸ”¢ Similarity scores

---

## âš™ï¸ Advanced Configuration

### Adjust Generation Quality

**In website console (F12):**

```javascript
// Faster but lower quality
formData.append("steps", "30"); // default: 50

// Smaller images (faster)
formData.append("height", "384"); // default: 512
formData.append("width", "384");
```

### Adjust Brightness Threshold

```javascript
formData.append("brightness_thresh", "40"); // default: 50
formData.append("max_retries", "5"); // default: 3
```

---

## ğŸ› Troubleshooting

### Issue 1: "Database not loaded"

**Check:**

```powershell
ls database_embeddings\fashioniq_database.pt
```

**Fix:**

```powershell
python extract_database_features.py
```

---

### Issue 2: "SDXL pipeline not loaded"

**Check:**

```powershell
ls models\checkpoint-20000-SDXL\checkpoint-20000\unet\
```

**Fix:** Ensure files exist:

- `config.json`
- `diffusion_pytorch_model.safetensors`

---

### Issue 3: "CUDA out of memory"

**Option 1: Reduce batch size**

```python
# In api_pseudo_target.py line ~280, modify:
height = 384  # instead of 512
width = 384
steps = 30    # instead of 50
```

**Option 2: Use CPU** (cháº­m)

```powershell
$env:CUDA_VISIBLE_DEVICES="-1"
python api_pseudo_target.py
```

---

### Issue 4: Generated image too dark

**Automatic:** API auto-retry vá»›i seeds khÃ¡c

**Manual adjust:** Giáº£m brightness_thresh trong request

---

### Issue 5: Website khÃ´ng connect Ä‘Æ°á»£c API

**Check 1: API Ä‘ang cháº¡y?**

```powershell
curl http://localhost:5000/health
```

**Check 2: Port bá»‹ block?**

```powershell
# Check port 5000
netstat -ano | findstr :5000
```

**Fix:** Restart API hoáº·c Ä‘á»•i port

---

## ğŸ“Š Expected Performance

### Hardware: RTX 3080 (12GB)

| Step                    | Time     |
| ----------------------- | -------- |
| Load models (startup)   | ~30s     |
| Extract ref features    | 0.1s     |
| Phi network             | 0.05s    |
| SDXL generation         | 12s      |
| Extract pseudo features | 0.1s     |
| Database search         | 0.1s     |
| **Total per query**     | **~15s** |

### Hardware: RTX 3060 (8GB)

| Step                  | Time     |
| --------------------- | -------- |
| Load models (startup) | ~45s     |
| SDXL generation       | 20s      |
| **Total per query**   | **~25s** |

### Hardware: CPU only

| Step                | Time       |
| ------------------- | ---------- |
| SDXL generation     | 3-5 min    |
| **Total per query** | **~5 min** |

---

## ğŸ“ For Information Retrieval Assignment

### Checklist:

- [x] Models downloaded vÃ  setup
- [x] Database extracted
- [x] API server hoáº¡t Ä‘á»™ng
- [x] Website demo hoáº¡t Ä‘á»™ng
- [ ] Test vá»›i multiple queries
- [ ] Screenshot results cho report
- [ ] Measure Recall@K metrics

### Suggested Experiments:

1. **Compare approaches:**

   - Run `api.py` (Direct Embedding)
   - Run `api_pseudo_target.py` (Pseudo-Target)
   - Compare results cho cÃ¹ng query

2. **Analyze pseudo-targets:**

   - Save generated pseudo-target images
   - Check if they match text description
   - Analyze failure cases

3. **Measure metrics:**
   - Use CIRR/FashionIQ test splits
   - Calculate Recall@1, Recall@10
   - Compare vá»›i paper results

---

## ğŸ“š Useful Commands

```powershell
# Check GPU usage
nvidia-smi

# Check API logs
# (In API terminal, logs print automatically)

# Test specific query
curl -X POST http://localhost:5000/search `
  -F "image=@test_image.jpg" `
  -F "query=change to red color"

# Get database stats
curl http://localhost:5000/stats
```

---

## ğŸ‰ Success Indicators

âœ… **Setup Complete** when:

- [ ] Test script passes all tests
- [ ] API health returns "healthy"
- [ ] Website loads without errors
- [ ] Can upload image vÃ  enter query
- [ ] Pseudo-target generates successfully
- [ ] Results display with scores

âœ… **Ready for Assignment** when:

- [ ] Understand workflow
- [ ] Can explain pseudo-target approach
- [ ] Tested multiple queries
- [ ] Measured some accuracy metrics
- [ ] Have screenshots for report

---

## ğŸ“– Documentation Files

- `PSEUDO_TARGET_SETUP.md` - Detailed setup guide
- `APPROACH_COMPARISON.md` - Direct vs Pseudo-Target
- `README_NEW.md` - Project overview
- `WEBSITE_GUIDE.md` - Website development guide
- `IMAGE_INPUT_GUIDE.md` - Image input guidelines

---

## ğŸ’¬ Need Help?

### Common Questions:

**Q: CÃ³ cáº§n cáº£ 2 approaches khÃ´ng?**  
A: KhÃ´ng. DÃ¹ng Pseudo-Target (api_pseudo_target.py) lÃ  Ä‘á»§.

**Q: CÃ³ thá»ƒ dÃ¹ng áº£nh báº¥t ká»³ khÃ´ng?**  
A: CÃ³! Tá»‘t nháº¥t lÃ  áº£nh quáº§n Ã¡o. Xem `IMAGE_INPUT_GUIDE.md`

**Q: Pseudo-target cÃ³ Ä‘Ãºng khÃ´ng?**  
A: Kiá»ƒm tra xem áº£nh cÃ³ khá»›p vá»›i text query khÃ´ng. Náº¿u match â†’ Ä‘Ãºng!

**Q: Results khÃ´ng tá»‘t?**  
A: Check pseudo-target trÆ°á»›c. Náº¿u pseudo-target sai â†’ adjust query hoáº·c reference image.

---

**Happy Coding! ğŸš€âœ¨**

_Last updated: [Current Date]_
